---
import ProgrammerLayout from '../../layouts/ProgrammerLayout.astro';

export async function getStaticPaths() {
  const postModules = import.meta.glob('../../../content/blog/**/*.md', { eager: true });
  
  // Collect all tags with their posts
  const tagMap = new Map<string, any[]>();
  
  Object.entries(postModules).forEach(([path, module]: [string, any]) => {
    const post = { ...module, file: path };
    const tags = module.frontmatter.tag || [];
    const categories = module.frontmatter.category || [];
    const allTags = [...new Set([...categories, ...tags])].filter(Boolean);
    
    allTags.forEach((tag: string) => {
      const normalizedTag = tag.toLowerCase().replace(/\s+/g, '-');
      if (!tagMap.has(normalizedTag)) {
        tagMap.set(normalizedTag, []);
      }
      tagMap.get(normalizedTag)!.push({ ...post, originalTag: tag });
    });
  });
  
  // Generate paths for each tag
  return Array.from(tagMap.entries()).map(([tag, posts]) => ({
    params: { tag },
    props: { 
      tag: posts[0].originalTag, // Use original casing
      posts: posts.sort((a, b) => 
        new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime()
      )
    },
  }));
}

const { tag, posts } = Astro.props;
---

<ProgrammerLayout title={`Posts tagged with "${tag}"`} description={`All blog posts tagged with ${tag}`}>
  <div class="max-w-4xl mx-auto">
    <header class="mb-12">
      <div class="flex items-center gap-3 mb-4">
        <a 
          href="/tags" 
          class="text-green-600 dark:text-green-400 hover:underline font-mono text-sm"
        >
          ‚Üê All tags
        </a>
      </div>
      <div class="flex items-center gap-3 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-green-600 dark:text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-slate-100">
          {tag}
        </h1>
      </div>
      <p class="text-lg text-slate-600 dark:text-slate-400 font-mono">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'}
      </p>
    </header>

    <div class="space-y-8">
      {posts.map((post) => {
        // Calculate read time
        const rawContent = post.rawContent ? post.rawContent() : '';
        const words = rawContent.split(/\s+/).length;
        const readTime = Math.ceil(words / 200);
        
        // Format date
        const formattedDate = new Date(post.frontmatter.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        
        // Generate slug
        const slug = post.frontmatter.permalink
          ? post.frontmatter.permalink.replace(/^\//, '')
          : post.file.split('/').pop()?.split('.').shift();
        
        return (
          <article class="border-b border-slate-200 dark:border-slate-700 pb-8 last:border-b-0">
            <a href={`/${slug}`} class="group">
              <h2 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-3 group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">
                {post.frontmatter.title}
              </h2>
            </a>
            
            {post.frontmatter.description && (
              <p class="text-slate-600 dark:text-slate-400 mb-4">
                {post.frontmatter.description}
              </p>
            )}
            
            <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 dark:text-slate-400 font-mono">
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>{formattedDate}</span>
              </div>
              
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>{readTime} min read</span>
              </div>
            </div>
          </article>
        );
      })}
    </div>
  </div>
</ProgrammerLayout>
