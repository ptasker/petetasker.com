---
// This component wraps code blocks and adds a copy button
---

<div class="code-block-wrapper">
  <slot />
</div>

<script>
  // Add copy buttons to all code blocks
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre');
    
    codeBlocks.forEach((pre) => {
      // Skip if button already exists
      if (pre.parentElement?.classList.contains('code-block-container')) {
        return;
      }

      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-container';
      
      // Create copy button
      const button = document.createElement('button');
      button.className = 'copy-code-button';
      button.innerHTML = `
        <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span class="copy-text">Copy</span>
      `;
      
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent || pre.textContent || '';
        
        try {
          await navigator.clipboard.writeText(code);
          button.classList.add('copied');
          button.innerHTML = `
            <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span class="copy-text">Copied!</span>
          `;
          
          setTimeout(() => {
            button.classList.remove('copied');
            button.innerHTML = `
              <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span class="copy-text">Copy</span>
            `;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });
      
      // Wrap the pre element
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      wrapper.appendChild(button);
    });
  }

  // Run on initial load
  addCopyButtons();
  
  // Re-run after view transitions (if using Astro view transitions)
  document.addEventListener('astro:page-load', addCopyButtons);
</script>

<style is:global>
  /* Code block container with copy button */
  .code-block-container {
    position: relative;
    margin: 1.5rem 0;
  }

  .copy-code-button {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: rgba(74, 222, 128, 0.1);
    border: 1px solid rgba(74, 222, 128, 0.3);
    border-radius: 0.375rem;
    color: rgb(74, 222, 128);
    font-size: 0.75rem;
    font-family: 'Share Tech Mono', monospace;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0;
    z-index: 10;
  }

  .code-block-container:hover .copy-code-button {
    opacity: 1;
  }

  .copy-code-button:hover {
    background: rgba(74, 222, 128, 0.2);
    border-color: rgb(74, 222, 128);
  }

  .copy-code-button.copied {
    background: rgba(74, 222, 128, 0.2);
    border-color: rgb(74, 222, 128);
  }

  .copy-code-button .copy-icon {
    width: 1rem;
    height: 1rem;
  }

  /* Mobile: always show button */
  @media (max-width: 768px) {
    .copy-code-button {
      opacity: 1;
    }
  }

  /* Enhanced code block styling for Shiki syntax highlighting */
  .prose pre {
    padding: 1.25rem 1.5rem;
    overflow-x: auto;
    font-size: 0.875rem;
    line-height: 1.7;
    font-family: 'Share Tech Mono', 'Courier New', monospace;
    border-radius: 0.5rem;
  }

  /* Shiki generates a <code> inside <pre> with its own background */
  .prose pre code {
    background: transparent !important;
    padding: 0;
    color: inherit;
    font-size: inherit;
    border-radius: 0;
    display: block;
  }

  /* Inline code (not in pre blocks) */
  .prose :not(pre) > code {
    font-weight: 600;
    font-size: 0.9em;
    background-color: rgb(241 245 249) !important;
    color: rgb(22 163 74) !important;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }

  html.dark .prose :not(pre) > code {
    background-color: rgb(30 41 59) !important;
    color: rgb(74 222 128) !important;
  }

  /* Ensure Shiki's theme colors are preserved */
  .prose pre.shiki,
  .prose pre.astro-code {
    padding: 1.25rem 1.5rem;
  }

  /* Scrollbar styling for code blocks */
  .prose pre::-webkit-scrollbar {
    height: 8px;
  }

  .prose pre::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
  }

  .prose pre::-webkit-scrollbar-thumb {
    background: rgba(74, 222, 128, 0.5);
    border-radius: 4px;
  }

  .prose pre::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 222, 128, 0.7);
  }

  /* Better spacing for lists */
  .prose ul, .prose ol {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }

  .prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
</style>
